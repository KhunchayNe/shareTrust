"use client";

import React, { useState, useEffect } from "react";
import { Card, CardBody, CardHeader } from "@/components/ui/Card";
import { Badge } from "@/components/ui/Badge";
import { Button } from "@/components/ui/Button";
import { Input } from "@/components/ui/Input";
import { LoadingSpinner } from "@/components/ui/LoadingSpinner";
import { UserProfileCompact } from "@/components/auth/UserProfile";
import {
  formatPrice,
  formatDateRelative,
  formatTrustScore,
  getTrustLevelColor,
  getCategoryIcon,
  getStatusColor,
} from "@/lib/utils";
import type { SharingGroup, GroupFilters, SortOptions } from "@/types";
import { Search, Filter, ChevronDown, Star, Users, Clock } from "lucide-react";

const CATEGORIES = [
  { value: "streaming", label: "ðŸŽ¬ Streaming", icon: "ðŸŽ¬" },
  { value: "ai_tools", label: "ðŸ§  AI Tools", icon: "ðŸ§ " },
  { value: "gaming", label: "ðŸŽ® Gaming", icon: "ðŸŽ®" },
  { value: "software", label: "ðŸ’¼ Software", icon: "ðŸ’¼" },
  { value: "music", label: "ðŸŽµ Music", icon: "ðŸŽµ" },
  { value: "news", label: "ðŸ“° News", icon: "ðŸ“°" },
  { value: "education", label: "ðŸ“š Education", icon: "ðŸ“š" },
  { value: "productivity", label: "âš¡ Productivity", icon: "âš¡" },
];

const TRENDING_KEYWORDS = [
  "Netflix",
  "ChatGPT",
  "Spotify",
  "Adobe",
  "Disney+",
  "Midjourney",
];

export default function SearchPage() {
  const [groups, setGroups] = useState<SharingGroup[]>([]);
  const [loading, setLoading] = useState(false);
  const [searchQuery, setSearchQuery] = useState("");
  const [selectedCategory, setSelectedCategory] = useState<string>("");
  const [showFilters, setShowFilters] = useState(false);
  const [sortBy, setSortBy] = useState<SortOptions>({
    field: "created_at",
    direction: "desc",
  });

  // Mock search results
  const mockGroups: SharingGroup[] = [
    {
      id: "1",
      title: "Netflix Premium 4K - 2 Spots Left",
      description:
        "Share Netflix Premium 4K plan with up to 4 members. Perfect for movie lovers! HDR content, multiple screens supported.",
      category: "streaming",
      price_per_person: 150,
      currency: "THB",
      max_members: 4,
      current_members: 2,
      min_members: 3,
      creator_id: "user1",
      creator: {
        id: "user1",
        display_name: "John Doe",
        user_id: "line123",
        picture_url: "https://via.placeholder.com/40",
        trust_score: 85,
        is_verified: true,
        status: "active",
        badges: ["ðŸ”’ Trusted 50+", "âœ… Verified"],
      },
      escrow_status: "pending",
      status: "active",
      created_at: "2024-01-15T10:00:00Z",
      updated_at: "2024-01-15T10:00:00Z",
      expires_at: "2024-02-15T10:00:00Z",
      tags: ["4K", "HDR", "Multiple Screens", "HD Ready"],
      verification_required: true,
      auto_approve: false,
      members: [],
      subscription_details: {
        service_name: "Netflix",
        plan_name: "Premium 4K",
        features: ["4K Streaming", "4 Screens", "HDR Content", "Downloads"],
        original_price: 599,
        savings_percentage: 75,
        renewal_frequency: "monthly",
      },
    },
    {
      id: "2",
      title: "ChatGPT Plus - Last Spot!",
      description:
        "Share ChatGPT Plus subscription. Get access to GPT-4, advanced features, and priority access during high demand.",
      category: "ai_tools",
      price_per_person: 350,
      currency: "THB",
      max_members: 2,
      current_members: 1,
      min_members: 2,
      creator_id: "user2",
      creator: {
        id: "user2",
        display_name: "Jane Smith",
        user_id: "line456",
        picture_url: "https://via.placeholder.com/40",
        trust_score: 92,
        is_verified: true,
        status: "active",
        badges: ["ðŸ”’ Trusted 50+", "âœ… Verified", "â­ Top Creator"],
      },
      escrow_status: "pending",
      status: "active",
      created_at: "2024-01-14T15:30:00Z",
      updated_at: "2024-01-14T15:30:00Z",
      expires_at: "2024-02-14T15:30:00Z",
      tags: ["GPT-4", "AI", "Productivity", "Last Spot"],
      verification_required: true,
      auto_approve: true,
      members: [],
      subscription_details: {
        service_name: "OpenAI",
        plan_name: "ChatGPT Plus",
        features: [
          "GPT-4 Access",
          "Priority Queue",
          "Faster Response",
          "Image Generation",
        ],
        original_price: 799,
        savings_percentage: 56,
        renewal_frequency: "monthly",
      },
    },
  ];

  useEffect(() => {
    const performSearch = async () => {
      setLoading(true);
      try {
        // Simulate API delay
        await new Promise((resolve) => setTimeout(resolve, 500));

        // Filter based on search query and category
        let filteredGroups = mockGroups;

        if (searchQuery) {
          filteredGroups = filteredGroups.filter(
            (group) =>
              group.title.toLowerCase().includes(searchQuery.toLowerCase()) ||
              group.description
                .toLowerCase()
                .includes(searchQuery.toLowerCase()) ||
              group.tags?.some((tag) =>
                tag.toLowerCase().includes(searchQuery.toLowerCase()),
              ),
          );
        }

        if (selectedCategory) {
          filteredGroups = filteredGroups.filter(
            (group) => group.category === selectedCategory,
          );
        }

        // Sort results
        filteredGroups.sort((a, b) => {
          const aValue: number | string = a[sortBy.field];
          const bValue: number | string = b[sortBy.field];

          if (sortBy.direction === "desc") {
            return aValue > bValue ? -1 : aValue < bValue ? 1 : 0;
          } else {
            return aValue < bValue ? -1 : aValue > bValue ? 1 : 0;
          }
        });

        setGroups(filteredGroups);
      } catch (error) {
        console.error("Search failed:", error);
      } finally {
        setLoading(false);
      }
    };

    performSearch();
  }, [searchQuery, selectedCategory, sortBy]);

  const handleKeywordClick = (keyword: string) => {
    setSearchQuery(keyword);
  };

  const getCategoryLabel = (category: string) => {
    return CATEGORIES.find((cat) => cat.value === category)?.label || category;
  };

  const isNearlyFull = (group: SharingGroup) => {
    return group.current_members / group.max_members >= 0.75;
  };

  const isNewGroup = (group: SharingGroup) => {
    const createdAt = new Date(group.created_at);
    const now = new Date();
    const daysDiff =
      (now.getTime() - createdAt.getTime()) / (1000 * 60 * 60 * 24);
    return daysDiff <= 7;
  };

  return (
    <div className="min-h-screen bg-gray-50">
      <div className="container mx-auto px-4 py-6">
        {/* Header */}
        <div className="mb-6">
          <h1 className="text-2xl font-bold text-gray-900 mb-2">
            Search Groups
          </h1>
          <p className="text-gray-600">Find your perfect sharing group</p>
        </div>

        {/* Search Bar */}
        <Card className="mb-6">
          <CardBody>
            <div className="relative">
              <Search
                className="absolute left-3 top-3 text-gray-400"
                size={20}
              />
              <Input
                type="text"
                placeholder="Search for groups, services, or keywords..."
                value={searchQuery}
                onChange={(e) => setSearchQuery(e.target.value)}
                className="pl-10 pr-4 py-3 text-lg"
              />
              <Button
                variant="secondary"
                size="sm"
                onClick={() => setShowFilters(!showFilters)}
                className="absolute right-2 top-2"
              >
                <Filter size={16} />
                <ChevronDown
                  size={14}
                  className={`ml-1 transition-transform ${showFilters ? "rotate-180" : ""}`}
                />
              </Button>
            </div>

            {/* Quick Categories */}
            <div className="flex flex-wrap gap-2 mt-3">
              {CATEGORIES.slice(0, 6).map((category) => (
                <button
                  key={category.value}
                  onClick={() =>
                    setSelectedCategory(
                      selectedCategory === category.value ? "" : category.value,
                    )
                  }
                  className={`px-3 py-1 rounded-full text-sm transition-colors ${
                    selectedCategory === category.value
                      ? "bg-blue-600 text-white"
                      : "bg-gray-100 text-gray-700 hover:bg-gray-200"
                  }`}
                >
                  {category.icon} {category.label.split(" ")[1]}
                </button>
              ))}
            </div>
          </CardBody>
        </Card>

        {/* Filters Panel */}
        {showFilters && (
          <Card className="mb-6">
            <CardBody>
              <div className="space-y-4">
                <div>
                  <label className="block text-sm font-medium text-gray-700 mb-2">
                    Sort by
                  </label>
                  <select
                    value={sortBy.field}
                    onChange={(e) =>
                      setSortBy({
                        field: e.target.value as SortOptions["field"],
                        direction: sortBy.direction,
                      })
                    }
                    className="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500"
                  >
                    <option value="created_at">Latest First</option>
                    <option value="price_per_person">Price: Low to High</option>
                    <option value="trust_score">Trust Score</option>
                    <option value="current_members">Most Members</option>
                  </select>
                </div>
              </div>
            </CardBody>
          </Card>
        )}

        {/* Trending Keywords */}
        {!searchQuery && groups.length === 0 && (
          <Card className="mb-6">
            <CardHeader>
              <h3 className="font-semibold text-gray-900">Trending Searches</h3>
            </CardHeader>
            <CardBody>
              <div className="flex flex-wrap gap-2">
                {TRENDING_KEYWORDS.map((keyword) => (
                  <button
                    key={keyword}
                    onClick={() => handleKeywordClick(keyword)}
                    className="px-3 py-1 bg-gray-100 text-gray-700 rounded-full text-sm hover:bg-gray-200 transition-colors"
                  >
                    {keyword}
                  </button>
                ))}
              </div>
            </CardBody>
          </Card>
        )}

        {/* Loading State */}
        {loading && (
          <div className="flex justify-center py-8">
            <LoadingSpinner size="lg" />
          </div>
        )}

        {/* Search Results */}
        {!loading && (
          <>
            {searchQuery && (
              <div className="mb-4">
                <p className="text-gray-600">
                  {groups.length} result{groups.length !== 1 ? "s" : ""} for "
                  {searchQuery}"
                </p>
              </div>
            )}

            {groups.length === 0 ? (
              <div className="text-center py-12">
                <Search size={48} className="mx-auto text-gray-300 mb-4" />
                <h3 className="text-lg font-medium text-gray-900 mb-2">
                  No groups found
                </h3>
                <p className="text-gray-500 mb-4">
                  Try adjusting your search terms or browse all groups
                </p>
                <Button
                  variant="primary"
                  onClick={() => (window.location.href = "/browse")}
                >
                  Browse All Groups
                </Button>
              </div>
            ) : (
              <div className="space-y-4">
                {groups.map((group) => (
                  <Card
                    key={group.id}
                    className="hover:shadow-md transition-shadow"
                  >
                    <CardBody>
                      <div className="flex space-x-4">
                        {/* Group Image/Icon */}
                        <div className="flex-shrink-0">
                          {group.images && group.images.length > 0 ? (
                            <img
                              src={group.images[0]}
                              alt={group.title}
                              className="w-16 h-16 rounded-lg object-cover"
                            />
                          ) : (
                            <div className="w-16 h-16 rounded-lg bg-gray-200 flex items-center justify-center text-2xl">
                              {getCategoryIcon(group.category)}
                            </div>
                          )}
                        </div>

                        {/* Group Info */}
                        <div className="flex-1 min-w-0">
                          <div className="flex items-start justify-between mb-2">
                            <h3 className="font-semibold text-gray-900 text-lg truncate">
                              {group.title}
                            </h3>
                            <div className="flex items-center space-x-2 ml-2">
                              {isNearlyFull(group) && (
                                <Badge variant="warning" size="sm" rounded>
                                  âš¡ Nearly Full
                                </Badge>
                              )}
                              {isNewGroup(group) && (
                                <Badge variant="success" size="sm" rounded>
                                  ðŸ”¥ New
                                </Badge>
                              )}
                            </div>
                          </div>

                          <p className="text-gray-600 text-sm mb-2 line-clamp-2">
                            {group.description}
                          </p>

                          {/* Tags */}
                          {group.tags && group.tags.length > 0 && (
                            <div className="flex flex-wrap gap-1 mb-2">
                              {group.tags.slice(0, 3).map((tag, index) => (
                                <Badge key={index} variant="default" size="xs">
                                  {tag}
                                </Badge>
                              ))}
                              {group.tags.length > 3 && (
                                <Badge variant="default" size="xs">
                                  +{group.tags.length - 3}
                                </Badge>
                              )}
                            </div>
                          )}

                          {/* Group Details */}
                          <div className="flex items-center space-x-4 text-sm text-gray-600 mb-3">
                            <div className="flex items-center">
                              <Users size={16} className="mr-1" />
                              {group.current_members}/{group.max_members}
                            </div>
                            <div className="flex items-center">
                              <Clock size={16} className="mr-1" />
                              {formatDateRelative(group.expires_at)}
                            </div>
                            <div className="flex items-center">
                              <span className="text-green-600 font-semibold">
                                {formatPrice(
                                  group.price_per_person,
                                  group.currency,
                                )}
                              </span>
                            </div>
                          </div>

                          {/* Creator Info */}
                          <UserProfileCompact
                            user={group.creator}
                            showTrustLevel={true}
                          />
                        </div>

                        {/* Action Button */}
                        <div className="flex-shrink-0">
                          <Button
                            variant="primary"
                            size="sm"
                            onClick={() =>
                              (window.location.href = `/group/${group.id}`)
                            }
                          >
                            View Details
                          </Button>
                        </div>
                      </div>
                    </CardBody>
                  </Card>
                ))}
              </div>
            )}
          </>
        )}
      </div>
    </div>
  );
}
